#pragma once

#include <Arduino.h>

/*
 * NightTransitionService
 * ----------------------
 * Плавный переход DAY <-> NIGHT.
 *
 * Отвечает ТОЛЬКО за коэффициент ночи:
 *   0.0 — день
 *   1.0 — ночь
 *
 * Сервис:
 *  - НЕ рисует
 *  - НЕ знает про цвета
 *  - НЕ знает про UI
 *
 * Его задача — дать нормализованный коэффициент перехода,
 * который UI и Theme используют для blend'а.
 */

class NightTransitionService {
public:
    NightTransitionService();

    // ------------------------------------------------------------------------
    // control
    // ------------------------------------------------------------------------

    // Установка целевого состояния:
    //  true  -> идём в ночь
    //  false -> идём в день
    void setTarget(bool night);

    // Обновление перехода.
    // ДОЛЖНО вызываться регулярно (обычно в loop()).
    void update();

    // ------------------------------------------------------------------------
    // state
    // ------------------------------------------------------------------------

    // Возвращает true, если переход ещё не завершён
    bool transitioning() const;

    // Фактический коэффициент ночи:
    //  0.0 -> полный день
    //  1.0 -> полная ночь
    //
    // Оставлен для семантической ясности внутри логики night/day.
    float nightFactor() const;

    // Универсальное значение для UI и Theme:
    //  0.0 -> DAY
    //  1.0 -> NIGHT
    //
    // Именно ЭТОТ метод используется для blend'а цветов.
    float value() const;

private:
    bool     _targetNight; // к какому состоянию идём
    float    _factor;      // текущий коэффициент (0.0 .. 1.0)
    uint32_t _lastMs;      // время предыдущего update()

    // Скорость изменения коэффициента.
    // 0.00025f ~= полный переход ~4 секунды.
    static constexpr float SPEED = 0.00025f; // изменение в мс
};