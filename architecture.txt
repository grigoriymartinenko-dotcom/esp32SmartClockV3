# ESP32 Smart Clock v3 ‚Äî Architecture

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞**, —Ä–æ–ª–∏ —Å–µ—Ä–≤–∏—Å–æ–≤,
–ø—Ä–∏–Ω—Ü–∏–ø—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∏ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.

–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –≤–æ–∫—Ä—É–≥ –∏–¥–µ–∏ **—Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ UI –±–µ–∑ —Ç–∞–π–º–µ—Ä–æ–≤ –∏ delay**.

---

## üß± –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```text
[ Hardware Events ]
        ‚Üì
[ AppController ]
        ‚Üì
[ ScreenManager ]
        ‚Üì
[ Screen (Clock / Forecast / Settings) ]
        ‚Üì
[ Services Layer ]
        ‚Üì
[ Hardware Drivers ]
üéÆ AppController
–†–æ–ª—å:
–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Å–æ–±—ã—Ç–∏–π (–∫–Ω–æ–ø–∫–∏, —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è).

–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:

–ø—Ä–∏–Ω–∏–º–∞–µ—Ç ButtonEvent

—Ä–µ—à–∞–µ—Ç, –∫–∞–∫–æ–º—É —ç–∫—Ä–∞–Ω—É –ø–µ—Ä–µ–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ

–ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —ç–∫—Ä–∞–Ω—ã

–Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç UI-–ª–æ–≥–∏–∫–∏

–í–∞–∂–Ω–æ:

AppController –Ω–µ –∑–Ω–∞–µ—Ç, –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —ç–∫—Ä–∞–Ω

—Ç–æ–ª—å–∫–æ –∫–æ–º—É –∏ –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ

ü™ü ScreenManager
–†–æ–ª—å:
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–º —ç–∫—Ä–∞–Ω–æ–º.

–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:

—Ö—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â–∏–π Screen

–≤—ã–∑—ã–≤–∞–µ—Ç begin() –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏

–≤—ã–∑—ã–≤–∞–µ—Ç update() –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ

–ü—Ä–∞–≤–∏–ª–æ:

ScreenManager –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫–∏ —ç–∫—Ä–∞–Ω–æ–≤.

üß© Screen (–±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å)
–ö–∞–∂–¥—ã–π —ç–∫—Ä–∞–Ω –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç Screen.

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
cpp
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
class Screen {
public:
    virtual void begin();
    virtual void update();
    virtual void onThemeChanged();
};
–ü—Ä–∏–Ω—Ü–∏–ø—ã:
begin() ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

update() ‚Äî —Ä–µ–∞–∫—Ç–∏–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞

—ç–∫—Ä–∞–Ω —Å–∞–º —Ä–µ—à–∞–µ—Ç, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å—Å—è

–Ω–µ—Ç delay() –∏ millis() –≤–Ω—É—Ç—Ä–∏ UI

üß† Services Layer (—è–¥—Ä–æ –ø—Ä–æ–µ–∫—Ç–∞)
–°–µ—Ä–≤–∏—Å—ã ‚Äî —ç—Ç–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –æ—Ç UI.

–û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
‚ùå –Ω–µ –∑–Ω–∞—é—Ç –ø—Ä–æ —ç–∫—Ä–∞–Ω—ã

‚ùå –Ω–µ —Ä–∏—Å—É—é—Ç

‚ùå –Ω–µ —á–∏—Ç–∞—é—Ç –∫–Ω–æ–ø–∫–∏

‚úÖ —Ö—Ä–∞–Ω—è—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ

‚úÖ —É–≤–µ–¥–æ–º–ª—è—é—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

‚úÖ –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —ç–∫—Ä–∞–Ω–∞–º–∏

üïí TimeService
–†–æ–ª—å:
–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤—Ä–µ–º–µ–Ω–∏.

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

—Ä–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏ (AUTO / RTC / NTP / LOCAL)

—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è

—Ç–∞–π–º–∑–æ–Ω—É + DST

—Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:

ClockScreen

StatusBar

ForecastScreen

SettingsScreen

–ü—Ä–∏–Ω—Ü–∏–ø:

–≠–∫—Ä–∞–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã—á–∏—Å–ª—è–µ—Ç –≤—Ä–µ–º—è —Å–∞–º.

üåô NightService
–†–æ–ª—å:
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

—Ä–µ–∂–∏–º (AUTO / ON / OFF)

–≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω

–≤—ã—á–∏—Å–ª–µ–Ω–∏–µ isNight()

–í–∞–∂–Ω–æ:

NightService –Ω–µ –º–µ–Ω—è–µ—Ç —Ç–µ–º—É

—Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–∞–µ—Ç, –Ω–æ—á—å —Å–µ–π—á–∞—Å –∏–ª–∏ –Ω–µ—Ç

üé® ThemeService
–†–æ–ª—å:
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ö–µ–º–æ–π.

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

—Ç–µ–∫—É—â—É—é —Ç–µ–º—É (day / night)

—Ü–≤–µ—Ç–∞ UI-—ç–ª–µ–º–µ–Ω—Ç–æ–≤

—Å–æ–±—ã—Ç–∏–µ onThemeChanged()

–ü—Ä–∏–Ω—Ü–∏–ø:

–¢–æ–ª—å–∫–æ ThemeService –∑–Ω–∞–µ—Ç, –∫–∞–∫–∏–µ —Ü–≤–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.

üìê LayoutService
–†–æ–ª—å:
–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç UI.

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

—Ä–∞–∑–º–µ—Ä—ã –∑–æ–Ω (status / clock / bottom)

–ø–æ–∑–∏—Ü–∏–∏ –ª–∏–Ω–∏–π

–≤—ã—Å–æ—Ç—ã –æ–±–ª–∞—Å—Ç–µ–π

–í–∞–∂–Ω–æ:

LayoutService –Ω–µ —Ä–∏—Å—É–µ—Ç

LayoutService –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ —Ç–µ–º—ã

–ü—Ä–∏–Ω—Ü–∏–ø:

–í –ø—Ä–æ–µ–∫—Ç–µ –Ω–µ—Ç –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç.

üå¶Ô∏è ForecastService
–†–æ–ª—å:
–ü–æ–ª—É—á–µ–Ω–∏–µ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ–≥–æ–¥—ã.

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

HTTP-–∑–∞–ø—Ä–æ—Å—ã –∫ OpenWeather

–ø–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞

–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:

ForecastScreen

ClockScreen (–Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å)

üíæ PreferencesService
–†–æ–ª—å:
–•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫.

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

—á—Ç–µ–Ω–∏–µ / –∑–∞–ø–∏—Å—å EEPROM

timezone, DST

night mode

source –≤—Ä–µ–º–µ–Ω–∏

–ü—Ä–∞–≤–∏–ª–æ:

–≠–∫—Ä–∞–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–µ—Ç –≤ EEPROM –Ω–∞–ø—Ä—è–º—É—é.

üß™ DhtService
–†–æ–ª—å:
–†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç—á–∏–∫–æ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã/–≤–ª–∞–∂–Ω–æ—Å—Ç–∏.

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

—á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é

–∫–µ—à –∑–Ω–∞—á–µ–Ω–∏–π

‚öôÔ∏è SettingsScreen ‚Äî –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π
SettingsScreen ‚Äî —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π —ç–∫—Ä–∞–Ω, –ø–æ—ç—Ç–æ–º—É –æ–Ω –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞–Ω.

text
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
SettingsScreen
 ‚îú‚îÄ SettingsScreen.cpp   ‚Üí flow + –∫–Ω–æ–ø–∫–∏ + apply
 ‚îú‚îÄ SettingsDraw.cpp     ‚Üí –¢–û–õ–¨–ö–û draw*
 ‚îú‚îÄ SettingsNav.cpp      ‚Üí –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–∫—É—Ä—Å–æ—Ä)
 ‚îú‚îÄ SettingsEdit.cpp     ‚Üí –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
 ‚îî‚îÄ SettingsTypes.h      ‚Üí enum / MenuItem
–ü—Ä–∏–Ω—Ü–∏–ø—ã:
draw / nav / edit –Ω–µ —Å–º–µ—à–∏–≤–∞—é—Ç—Å—è

–∫–∞–∂–¥—É—é —á–∞—Å—Ç—å –º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ

–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é –Ω–µ –ª–æ–º–∞–µ—Ç –∫–æ–¥

üß≠ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏–º–µ—Ä)
text
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
Button RIGHT
   ‚Üì
AppController
   ‚Üì
SettingsScreen::onShortRight()
   ‚Üì
SettingsNav::navRight()
   ‚Üì
_state change
   ‚Üì
_dirty = true
   ‚Üì
draw()
üö´ –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã (—á–µ–≥–æ –ù–ï–¢ –≤ –ø—Ä–æ–µ–∫—Ç–µ)
‚ùå delay() –≤ UI

‚ùå millis() –≤ —ç–∫—Ä–∞–Ω–∞—Ö

‚ùå –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ EEPROM

‚ùå –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —ç–∫—Ä–∞–Ω–∞—Ö

‚ùå –ª–æ–≥–∏–∫–∞ –≤ draw-—Ñ—É–Ω–∫—Ü–∏—è—Ö

üß© –ö–∞–∫ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω
–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å NewScreen : public Screen

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã, –Ω–µ –¥—É–±–ª–∏—Ä—É—è –ª–æ–≥–∏–∫—É

–î–æ–±–∞–≤–∏—Ç—å —ç–∫—Ä–∞–Ω –≤ ScreenManager

–ù–µ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏–∑ –¥—Ä—É–≥–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤

üß† –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è –ø—Ä–æ–µ–∫—Ç–∞
–≠–∫—Ä–∞–Ω ‚Äî —ç—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è,
—Å–µ—Ä–≤–∏—Å ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.

üìå –°—Ç–∞—Ç—É—Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
Services layer ‚Äî ‚úÖ —Å—Ç–∞–±–∏–ª–µ–Ω

UI architecture ‚Äî ‚úÖ –∑–∞–≤–µ—Ä—à–µ–Ω–∞

SettingsScreen ‚Äî ‚úÖ —ç—Ç–∞–ª–æ–Ω

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é ‚Äî üöÄ
